{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/H%20P/Desktop/SAFarmHouse/lib/mongodb.ts"],"sourcesContent":["\r\nimport { MongoClient } from 'mongodb';\r\n\r\n// Replace the URI below with your actual MongoDB Atlas connection string\r\nconst uri = process.env.MONGODB_URI;\r\n\r\nif (!uri) {\r\n  throw new Error('Please add your MongoDB URI to .env.local as MONGODB_URI');\r\n}\r\n\r\nlet client: MongoClient;\r\nlet clientPromise: Promise<MongoClient>;\r\n\r\nif (process.env.NODE_ENV === 'development') {\r\n  // In development mode, use a global variable so that the value\r\n  // is preserved across module reloads caused by HMR (Hot Module Replacement).\r\n  if (!(global as any)._mongoClientPromise) {\r\n    client = new MongoClient(uri);\r\n    (global as any)._mongoClientPromise = client.connect();\r\n  }\r\n  clientPromise = (global as any)._mongoClientPromise;\r\n} else {\r\n  // In production mode, it's best to not use a global variable.\r\n  client = new MongoClient(uri, {\r\n    // Options for serverless environments\r\n    maxPoolSize: 1, // Maintain up to 1 connection per lambda\r\n    serverSelectionTimeoutMS: 5000, // Keep trying to send operations for 5 seconds\r\n    socketTimeoutMS: 45000, // Close sockets after 45 seconds of inactivity\r\n  });\r\n  clientPromise = client.connect();\r\n}\r\n\r\nexport default clientPromise;\r\n"],"names":[],"mappings":";;;;AACA;;AAEA,yEAAyE;AACzE,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AAEnC,IAAI,CAAC,KAAK;IACR,MAAM,IAAI,MAAM;AAClB;AAEA,IAAI;AACJ,IAAI;AAEJ,wCAA4C;IAC1C,+DAA+D;IAC/D,6EAA6E;IAC7E,IAAI,CAAC,yDAAgB,mBAAmB,EAAE;QACxC,SAAS,IAAI,oKAAW,CAAC;QACzB,yDAAgB,mBAAmB,GAAG,OAAO,OAAO;IACtD;IACA,gBAAgB,yDAAgB,mBAAmB;AACrD;;uCAWe"}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/H%20P/Desktop/SAFarmHouse/app/api/transactions/route.ts"],"sourcesContent":["\r\nimport { NextResponse } from 'next/server';\r\nimport { ObjectId } from 'mongodb';\r\nimport clientPromise from '../../../lib/mongodb';\r\n\r\nconst DB_NAME = \"farmshop\";\r\nconst COLLECTION_NAME = \"transactions\";\r\n\r\nexport async function GET() {\r\n  try {\r\n    const client = await clientPromise;\r\n    const db = client.db(DB_NAME);\r\n    const transactions = await db.collection(COLLECTION_NAME)\r\n      .find({})\r\n      .sort({ createdAt: -1 })\r\n      .toArray();\r\n\r\n    // Get all unique dealer IDs\r\n    const dealerIds = [...new Set(transactions.map(t => t.dealerId).filter(id => id))];\r\n    const dealers = dealerIds.length > 0 ? await db.collection('dealers')\r\n      .find({ _id: { $in: dealerIds.map(id => new ObjectId(id)) } })\r\n      .toArray() : [];\r\n\r\n    // Create dealer name map\r\n    const dealerMap = new Map(dealers.map(d => [d._id.toString(), d.name]));\r\n\r\n    // Map _id to id and add dealerName\r\n    const formatted = transactions.map(t => ({\r\n      ...t,\r\n      id: t._id.toString(),\r\n      dealerName: dealerMap.get(t.dealerId) || 'Unknown Dealer',\r\n      _id: undefined\r\n    }));\r\n\r\n    return NextResponse.json(formatted);\r\n  } catch (e) {\r\n    console.error(e);\r\n    return NextResponse.json({ error: 'Failed to fetch' }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const body = await request.json();\r\n    const client = await clientPromise;\r\n    const db = client.db(DB_NAME);\r\n    \r\n    const newTransaction = {\r\n      ...body,\r\n      totalAmount: body.weightKg * body.pricePerKg,\r\n      createdAt: Date.now(),\r\n      isPaid: body.isPaid || false\r\n    };\r\n\r\n    const result = await db.collection(COLLECTION_NAME).insertOne(newTransaction);\r\n    \r\n    // Get dealer name for the response\r\n    let dealerName = 'Unknown Dealer';\r\n    if (body.dealerId) {\r\n      try {\r\n        const dealer = await db.collection('dealers').findOne({ _id: new ObjectId(body.dealerId) });\r\n        if (dealer) dealerName = dealer.name;\r\n      } catch (e) {\r\n        console.error('Failed to fetch dealer name:', e);\r\n      }\r\n    }\r\n    \r\n    return NextResponse.json({\r\n      ...newTransaction,\r\n      id: result.insertedId.toString(),\r\n      dealerName\r\n    });\r\n  } catch (e) {\r\n    console.error(e);\r\n    return NextResponse.json({ error: 'Failed to save' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AACA;AACA;AACA;;;;AAEA,MAAM,UAAU;AAChB,MAAM,kBAAkB;AAEjB,eAAe;IACpB,IAAI;QACF,MAAM,SAAS,MAAM,2HAAa;QAClC,MAAM,KAAK,OAAO,EAAE,CAAC;QACrB,MAAM,eAAe,MAAM,GAAG,UAAU,CAAC,iBACtC,IAAI,CAAC,CAAC,GACN,IAAI,CAAC;YAAE,WAAW,CAAC;QAAE,GACrB,OAAO;QAEV,4BAA4B;QAC5B,MAAM,YAAY;eAAI,IAAI,IAAI,aAAa,GAAG,CAAC,CAAA,IAAK,EAAE,QAAQ,EAAE,MAAM,CAAC,CAAA,KAAM;SAAK;QAClF,MAAM,UAAU,UAAU,MAAM,GAAG,IAAI,MAAM,GAAG,UAAU,CAAC,WACxD,IAAI,CAAC;YAAE,KAAK;gBAAE,KAAK,UAAU,GAAG,CAAC,CAAA,KAAM,IAAI,iKAAQ,CAAC;YAAK;QAAE,GAC3D,OAAO,KAAK,EAAE;QAEjB,yBAAyB;QACzB,MAAM,YAAY,IAAI,IAAI,QAAQ,GAAG,CAAC,CAAA,IAAK;gBAAC,EAAE,GAAG,CAAC,QAAQ;gBAAI,EAAE,IAAI;aAAC;QAErE,mCAAmC;QACnC,MAAM,YAAY,aAAa,GAAG,CAAC,CAAA,IAAK,CAAC;gBACvC,GAAG,CAAC;gBACJ,IAAI,EAAE,GAAG,CAAC,QAAQ;gBAClB,YAAY,UAAU,GAAG,CAAC,EAAE,QAAQ,KAAK;gBACzC,KAAK;YACP,CAAC;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkB,GAAG;YAAE,QAAQ;QAAI;IACvE;AACF;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,SAAS,MAAM,2HAAa;QAClC,MAAM,KAAK,OAAO,EAAE,CAAC;QAErB,MAAM,iBAAiB;YACrB,GAAG,IAAI;YACP,aAAa,KAAK,QAAQ,GAAG,KAAK,UAAU;YAC5C,WAAW,KAAK,GAAG;YACnB,QAAQ,KAAK,MAAM,IAAI;QACzB;QAEA,MAAM,SAAS,MAAM,GAAG,UAAU,CAAC,iBAAiB,SAAS,CAAC;QAE9D,mCAAmC;QACnC,IAAI,aAAa;QACjB,IAAI,KAAK,QAAQ,EAAE;YACjB,IAAI;gBACF,MAAM,SAAS,MAAM,GAAG,UAAU,CAAC,WAAW,OAAO,CAAC;oBAAE,KAAK,IAAI,iKAAQ,CAAC,KAAK,QAAQ;gBAAE;gBACzF,IAAI,QAAQ,aAAa,OAAO,IAAI;YACtC,EAAE,OAAO,GAAG;gBACV,QAAQ,KAAK,CAAC,gCAAgC;YAChD;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,GAAG,cAAc;YACjB,IAAI,OAAO,UAAU,CAAC,QAAQ;YAC9B;QACF;IACF,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;IACtE;AACF"}}]
}